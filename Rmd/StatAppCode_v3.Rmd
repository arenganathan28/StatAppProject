---
title: "StatApps Project"
author: "A. Renganathan & Y.Baldonado"
date: "2023-04-07"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# INSTALL PACKAGES ###############################

#install.packages("utils")
#install.packages("devtools")
#install.packages("survey")
#install.packages("dplyr")
#install.packages("tidyverse")
#install.packages("jtools")
#install.packages("dataMaid")
#install.packages("expss")
#install.packages("ggsurvey")

##Installing Updated RNHANES package

#remove CRAN version of RNHANES PACKAGE (outdated, does not include 2017-2018 cycle)
      library(utils)
      #detach("package:RNHANES", unload = TRUE)
      
#install devtools in order to install the updated RNHANES package from github
      #install.packages("devtools")
      library(devtools)

#install RNHANES updated vers from github
#you can only run this once, so it's commented out
      #install_github("silentspringinstitute/RNHANES")

# LOAD LIBRARIES ###############################



#LOAD LIBRARIES
library(RNHANES) #package used to download NHANES data directly from the website
library(survey)#package used for complex survey design and analysis, incorporates weights
library(dplyr) #package used for recoding
library(tidyverse) #package used for recoding
#library(MASS) #package for stepwise regression -- ADDED LATER BC IT MASKS DPLYR
library(jtools) #package for summarizing logistic regressions
library(ggplot2) #package for graphs
library(ggeffects) #for prediction plots
library(WeightedROC) #package to create ROC curves
library(ggsurvey) #package to create weighted survey plots



#NOTE ON DPLYR AND CAR
#recoding is done utilizing dplyr, detach car package to avoid errors
#if car is not loaded, the following will spit out an error
#if car is loaded, it will not
#detach(package:MASS, unload = TRUE)

```

#Prologue

##Purpose

##DATA

```{r data management}

#overall dataframe download for 2017-2018
nhanes<- nhanes_load_data(c("DEMO", "DR1TOT", "DSQTOT", "OSQ"), c("2017-2018","2017-2018","2017-2018","2017-2018"), cache=TRUE)


demo <- nhanes$DEMO %>%
  select(SEQN, #identifier
         SDDSRVYR,#survey year
         SDMVPSU, #masked variance pseudo-primary sampling units
         SDMVSTRA,#masked variance pseudo-stratum
         WTMEC2YR, #examination weights
         RIDAGEYR, #age
         RIAGENDR #gender
         ) %>%
  rename(age = RIDAGEYR) %>%
  rename(gender = RIAGENDR)

dietary<- nhanes$DR1TOT %>%
  select (SEQN, #identifier
          DR1TCALC, #day 1 dietary calcium
          DR1TVD, #day 1 dietary vitamin d
          WTDRD1 #full sample 2 year mobile examination center(where day 1 diet interview occurred) weight) 
          ) %>% 
  rename(calcium_intake = DR1TCALC) %>%
  rename(vitamin_d= DR1TVD)

supplements <- nhanes$DSQTOT %>%
  select(SEQN, #identifier
         DSQTVD, #supplemental vitamin d
         DSQTCALC #supplemental calcium
         )%>%
  rename(vitamind_supp = DSQTVD) %>%
  rename(calcium_supp= DSQTCALC)

osteo <- nhanes$OSQ %>%
  select(SEQN, #identifier
         OSQ060, #reported diagnosis osteoporosis
         OSQ010B #reported fractured wrist
         ) %>%
  rename(osteoporosis = OSQ060) %>%
  rename(fractured_wrist = OSQ010B) 

  
#remove larger nhanes file
rm(nhanes)

#joining dataframes by main identifier (SEQN) and limiting population to 50+yo due to OSQ data
os <- demo %>%
  full_join(dietary, by = "SEQN") %>%
  full_join(supplements, by = "SEQN") %>%
  full_join(osteo, by = "SEQN") %>%
  filter(age>=50)



count(os) 
#n=3069

```

```{r recoding data}
os.recoded<- os %>%
  mutate(gender= recode_factor(.x=gender,
                                 `1`='Male',
                                 `2`='Female')) %>%
  mutate(osteoporosis= recode_factor(.x=osteoporosis,
                                 `1`='Yes',
                                 `2`= 'No',
                                 `7`= NA_character_,
                                 `9`= NA_character_))%>%
  mutate(fractured_wrist= recode_factor(.x=fractured_wrist,
                                 `1`='Yes',
                                 `2`= 'No',
                                 `7`= NA_character_,
                                 `9`= NA_character_))%>%
  mutate(WTDRD1 = as.numeric(WTDRD1)) %>%
  mutate(WTMEC2YR = as.numeric(WTMEC2YR)) %>%
  mutate(WTDRD1 = coalesce(WTDRD1, WTMEC2YR))


rm(osteo_data2)
rm(osteo_data3)
rm(osteo_data4)
summary(os.recoded)
```

##Survey Design

```{r survey design}
#sample weight for aggregate data is INT2YR
#do not na.omit with survey data. you need the whole set for the weights to work
svydsgn <- svydesign(data = os.recoded,
                     id=~SDMVPSU,
                     strata = ~SDMVSTRA,
                     weights = ~WTDRD1,
                     nest=TRUE)

#subset by age
restr.age <- subset(svydsgn,
                        age>=50,
                        options(na.action = "na.pass"))

osteo.svydsgn <- restr.age

osteo.svydsgn2 <- subset(svydsgn,
                        age>=50,
                        options(na.action = "na.omit"))

#subset by osteoporosis
svydsgn.osteo <- subset(restr.age,
                      osteoporosis=="Yes",
                      options(na.action="na.pass"))
svydsgn.no.osteo<-subset(restr.age,
                      osteoporosis=="No",
                   options(na.action="na.pass"))


```

```{r descr stats and chi-sq, echo=FALSE}
#age
svymean(~age, svydsgn.no.osteo)
svymean(~age, svydsgn.osteo)

#calculate standard deviation, called 'variance' below 
#you can only use this on numeric variables, not factors/categorical
sqrt(svyvar(~age, svydsgn.osteo))
sqrt(svyvar(~age, svydsgn.no.osteo))

#gender
svymean(~gender, svydsgn.no.osteo)*100
svymean(~gender, svydsgn.osteo)*100

#race eth
svymean(~race_ethnicity, svydsgn.no.osteo)*100
svymean(~race_ethnicity, svydsgn.osteo)*100

#calcium intake
svymean(~calcium_intake, svydsgn.osteo, na.rm = TRUE) 
svymean(~calcium_intake, svydsgn.no.osteo, na.rm = TRUE)

#vitamin d intake
svymean(~vitamin_d, svydsgn.osteo, na.rm = TRUE)
svymean(~vitamin_d, svydsgn.no.osteo, na.rm = TRUE) 

#calcium supp
svymean(~calcium_supp, svydsgn.osteo, na.rm = TRUE)
svymean(~calcium_supp, svydsgn.no.osteo, na.rm = TRUE)

#vitamin d supp
svymean(~vitamind_supp, svydsgn.osteo, na.rm = TRUE)
svymean(~vitamind_supp, svydsgn.no.osteo, na.rm = TRUE)

#fractured wrist
svymean(~fractured_wrist, svydsgn.osteo)*100
svymean(~fractured_wrist, svydsgn.no.osteo, na.rm = TRUE)*100

#dairy
svymean(~dairy, svydsgn.osteo)*100
svymean(~dairy, svydsgn.no.osteo)*100

#nondairy
svymean(~nondairy, svydsgn.osteo)*100
svymean(~nondairy, svydsgn.no.osteo)*100


#INDEPENDENCE: chi-sq tests for diff btwn osteoporosis status
svychisq(~age+osteoporosis ,design = osteo.svydsgn, statistic=c("Chisq")) #signf <0.0001
svychisq(~race_ethnicity+osteoporosis ,design = osteo.svydsgn, statistic=c("Chisq")) #not signf
svychisq(~gender+osteoporosis ,design = osteo.svydsgn, statistic=c("Chisq")) # signf <0.0001
svyttest(calcium_intake~osteoporosis, design=osteo.svydsgn) #signf <0.05
svyttest(vitamin_d~osteoporosis, design=osteo.svydsgn) #not signf
svyttest(vitamind_supp~osteoporosis, design=osteo.svydsgn)#not signf
svyttest(calcium_supp~osteoporosis, design=osteo.svydsgn) #signf <0.001
svychisq(~fractured_wrist+osteoporosis ,design = osteo.svydsgn, statistic=c("Chisq")) #not signf
svychisq(~dairy+osteoporosis ,design = osteo.svydsgn, statistic=c("Chisq")) #not signf
svychisq(~nondairy+osteoporosis ,design = osteo.svydsgn, statistic=c("Chisq")) #not signf



```



``` {r Exploratory Analysis}

#removing univariate logreg models bc not needed

#For cont variables: Scatterplot
pairs(cbind(age, calcium_intake, calcium_supp, vitamin_d, vitamind_supp))
#for categorical: box plots 

#S-curve?
invlogit <- function(x) exp(x)/(1 + exp(x))
invlogit(-8.3 + 0.075 * 0 + 2.8* 0)
x <- seq(-3, 3, .01)
y <- invlogit(-8.3 + .075*x)
ggplot(data.frame(x = x, y = y), aes(x, y)) +
  geom_line() +
  ggtitle(expression(paste("y = ", logit^-1,"(-8.3 + 0.075*age)"))) + 
  ylab("probability of default") +
  xlab("age")


```

```{r 2way barplots}
osteo.svydsgn2 <- subset(svydsgn,
                        age>=50,
                        options(na.action = "na.omit"))

#gender

svyplot(osteoporosis~gender, design=osteo.svydsgn, style = "subsample", xlab="Gender", ylab= "Osteoporosis Diagnosis", main= "Weighted Osteoporosis Diagnosis across Gender")

library(ggsurvey)
ggbarcrosstabs_svy(osteo.svydsgn2, osteoporosis, gender) + labs(title = "Weighted Osteoporosis Diagnosis across Gender") 


#fractured wrist
svyplot(osteoporosis~fractured_wrist, design=osteo.svydsgn, style = "subsample", xlab="Ever fractured wrist?", ylab= "Osteoporosis Diagnosis", main= "Weighted Osteoporosis Diagnosis across Ever fractured wrist")

```

```{r multiple logreg models}
library(car)
library(MASS) #package for stepwise regression

restr.age$variables$osteoporosis<- relevel(restr.age$variables$osteoporosis, ref = "No")
#full model:
osteo_model0<- svyglm(osteoporosis ~ age + gender + vitamin_d + vitamind_supp +  calcium_intake + calcium_supp + fractured_wrist, design = restr.age, family = quasibinomial(link= "logit"), data = os.recoded)
summ(osteo_model0,
     exp=TRUE,
     confint=TRUE,
     model.fit = TRUE,
     model.info = TRUE,
     digits=2,
     vifs = TRUE)
summary(osteo_model0)

###age and female sig. 

#Multicollinearity check:
vif(osteo_model0) 
#plots
plot(ggpredict(osteo_model0), type = "response")


###DONT THINK THE FOLLOWING MODELS ARE NEEDED####
#basic + nutrients: vit D & calcium
osteo_nutrients<- svyglm(osteoporosis ~ age + gender + vitamin_d + vitamind_supp + calcium_intake + calcium_supp, design = restr.age,  family = binomial(link= "logit"), data = os.recoded)
summ(osteo_nutrients,
     exp=TRUE,
     confint=TRUE,
     model.fit = TRUE,
     model.info = TRUE,
     digits=2,
     vifs = TRUE)
summary(osteo_nutrients)


#basic + calcium:
osteo_calc<- svyglm(osteoporosis ~ age + gender + calcium_intake + calcium_supp, design = restr.age,  family = binomial(link= "logit"), data = os.recoded)
summ(osteo_calc,
     exp=TRUE,
     confint=TRUE,
     model.fit = TRUE,
     model.info = TRUE,
     digits=2,
     vifs = TRUE)
summary(osteo_calc)

#basic + vitamin D:
osteo_vitd<- svyglm(osteoporosis ~ age + gender + vitamin_d + vitamind_supp, design = restr.age,  family = binomial(link= "logit"), data = os.recoded)
summ(osteo_vitd,
     exp=TRUE,
     confint=TRUE,
     model.fit = TRUE,
     model.info = TRUE,
     digits=2,
     vifs = TRUE)
summary(osteo_vitd)
restr.age$variables$osteoporosis<- relevel(restr.age$variables$osteoporosis, ref = "No")
#model with only sig predictors:
osteo_sig <- svyglm(osteoporosis ~ age + gender + calcium_supp, design = restr.age,  family = binomial(link= "logit"), data = os.recoded)
summ(osteo_sig,
     exp=TRUE,
     confint=TRUE,
     model.fit = TRUE,
     model.info = TRUE,
     digits=2,
     vifs = TRUE)
summary(osteo_sig)

#multicollinearity check
vif(osteo_sig) # all below 5, no issues with multicollinearity

#logreg curve for best model:
####logistic reg plot#####
# Model: osteo_sig
plot(ggpredict(osteo_sig), type = "response")


```
